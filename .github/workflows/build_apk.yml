name: Build APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip python3-setuptools python3-wheel \
          openjdk-17-jdk git zip unzip \
          build-essential libffi-dev libssl-dev \
          cython3

    - name: Install buildozer
      run: |
        python3 -m pip install --user buildozer
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    # 安装 Android SDK 并指定版本 + build-tools
    - name: Setup Android SDK with Build Tools
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        packages: "platform-tools platforms;android-33 build-tools;34.0.0"

    # 强制让 buildozer 用 GitHub Actions 里的 SDK（关键）
    - name: Export Android env
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

    # 修复权限 + 接受许可证（必加）
    - name: Accept Android licenses
      run: |
        yes | sdkmanager --licenses
        chmod -R 755 $ANDROID_SDK_ROOT

    # 缓存 buildozer 下载的内容（加速、防止重复下载失败）
    - name: Cache buildozer and SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          ~/.local/share/buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: ${{ runner.os }}-buildozer-

    - name: Build debug APK
      run: |
        buildozer -v android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: bin/*.apk
